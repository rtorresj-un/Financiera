---
title: "Parcial 3 - Econometría Financiera"
subtitle: "Raúl Esteban Torres Jiménez & Juanita Cortés Arroyo"
output: 
  pdf_document:
    latex_engine: xelatex
---

```{r, include=FALSE}
library(quantmod); library(PerformanceAnalytics); library(rugarch); library(dplyr)
library(ggplot2); library(ggfortify); library(quantmod); library(gridExtra); library(forecast); library(cowplot); library(urca); library(timeDate); library(TSstudio); library(fBasics); library(randtests); library(vrtest)

library(xts);library(zoo); library(TTR);library(tidyverse);library(dplyr); library(stats); library(greybox); library(smooth);library(PerformanceAnalytics); library(rugarch)

getSymbols('USDJPY=X',from = "2005-01-01", to = "2021-08-31", periodicity = "daily")
jp <-Cl(`USDJPY=X`)

jp_r <- data.frame(apply(jp, 2, function(x) Delt(x, type = "log")), fecha = index(jp))
jp_r<-na.omit(jp_r)
jp_r<-xts(jp_r[,1], order.by = jp_r$fecha)
```

Supongan que ustedes son analistas del mercado financiero en una entidad privada que invierte en Bolsa. Con el fin de guiar su política de inversión, la mesa de dinero requiere un análisis del comportamiento de la tasa de cambio del dólar americano USD frente a un conjunto de monedas del mundo: euro, yen japones, libra esterlina, dólar canadiense, dólar australiano, franco suizo, peso mexicano, peso colombiano y real brasileño (disponibles en https://finance.yahoo.com/). En consecuencia, le piden que realice un análisis incluyendo datos diarios desde enero de 2005 y hasta agosto del 2021 el cual debe dar cuenta de:

  a. Estadística descriptiva (Además de otros análisis calcule la desviación estándar anualizada para los años de crisis (2008 y 2009), también la del año 2020 y comparela con la de la muestra completa.)
  
Se presenta la gráfica de la tasa de cambio del dolar americado \textbf{USD} frente al Yen japones \textbf{JPY}

```{r echo=FALSE ,message=FALSE ,fig.height = 3, fig.width = 5, fig.align = "center", fig.pos='h'}
knitr::opts_chunk$set(fig.width=4) 
ggplot(data = jp, aes(y = jp, x = index(jp))) + geom_line()+ggtitle("Tasa de cambio USD/JPY")+ labs(x = "Fecha",y = "USD/JPY") 
```

```{r echo=FALSE, fig.height = 5, fig.width = 5, fig.align = "center", warning = FALSE,fig.pos='h',message=FALSE}
grid.arrange(
ggAcf(jp,52)+ggtitle("USD/JPY")+labs(x=""),
ggPacf(jp,52)+ggtitle("")
)
```

```{r echo=FALSE, fig.height = 4, fig.width = 5, fig.align = "center", message=FALSE,fig.pos='h'}
# plot retornos diarios 
grid.arrange(
ggplot(data = jp_r, aes(y = jp_r[,1], x = index(jp_r))) + geom_line()+ggtitle("Retornos diarios USD/JPY")+ labs(x = "Fecha",y = "") + theme_minimal(),
ggplot(data = jp_r, aes(y=..density.., x = jp_r[,1])) +
  geom_histogram(bins = 200) +
  ggtitle("Distrubución retornos diarios") +
  geom_vline(aes(xintercept=mean(jp_r)), linetype="dashed") +
  geom_density(alpha=.2, fill="lightblue") + labs(x='',y='') +theme_minimal()
)
```

```{r echo=FALSE, fig.height = 4, fig.width = 5, fig.align = "center", warning = FALSE,fig.pos='h',message=FALSE}
#retornos ^2 distribucion y grafico
grid.arrange(
ggplot(data = jp_r, aes(y = jp_r^2, x = index(jp_r))) + 
  geom_line() +
  ggtitle("Volatilidad retornos USD/JPY") + 
  labs(x = "Fecha",y = "") + theme_minimal(),
ggplot(data = jp_r, aes(y=..density.., x = jp_r^2)) +
  geom_histogram(bins = 200) +
  ggtitle("Distrubución volatilidad retornos diarios") +
  geom_vline(aes(xintercept=mean(jp_r)), linetype="dashed") +
  geom_density(alpha=.2, fill="lightblue") + labs(x='',y='') + theme_minimal()
)
```

```{r echo=FALSE, caption='Estadística descriptiva.', warning = FALSE,fig.pos='h',message=FALSE}
stats_d<-basicStats(jp_r[,1])[c("Mean", "Stdev", "Minimum", "Maximum", "Variance","Skewness","Kurtosis"),]

#En tabla:
stats<-data.frame(stats_d)
row.names(stats)<-c("Mean", "SD", "Minimum", "Maximum", "Variance","Skewness","Kurtosis")
colnames(stats)<-c('USD/JPY')
knitr::kable(stats)
```

```{r echo=FALSE}
#calcule la desviación estándar anualizada para los años de crisis (2008 y 2009), también la del año 2020 y comparela con la de la muestra completa 
#chart.RollingPerformance(ret, width = 22, FUN = "sd.annualized", scale = 252, main = "One month rolling volatility")
# series ret de los años y aplicar la funcion 
```

```{r echo=FALSE, fig.height = 7, fig.width = 7, fig.align = "center", warning = FALSE,fig.pos='h',message=FALSE}
#chart.TimeSeries(jp)
jp_r08<-window(jp_r, start='2008-01-21', end='2009-12-31')
jp_r20<-window(jp_r, start='2020-01-01', end=Sys.Date())
#rollapply(jp_r)
par(mfrow=c(3,1))
chart.RollingPerformance(jp_r08, width = 22, FUN = "sd.annualized", scale = 252, main = "Volatilidad anualizada 2008-2009")
chart.RollingPerformance(jp_r20, width = 22, FUN = "sd.annualized", scale = 252, main = "Volatilidad anualizada 2020-2021")
chart.RollingPerformance(jp_r, width = 22, FUN = "sd.annualized", scale = 252, main = "Volatilidad anualizada total")

#Se observan clústeres de volatilidad, media que no es cero ni varianza constante => modelar volatilidad.
```

  b. Modelación de la media condicional. ¿Es la media condicional igual a cero?
```{r echo=FALSE,fig.pos='h',fig.height = 3, fig.width = 7, fig.align = "center", fig.show='hide'}
# media incondicional 
#dataSMA.EMA=merge.xts('Retornos'=jp_r, 'Media móvil simple'= SMA(jp_r), 'Media móvil exponencial'= EMA(jp_r), fill = 'NA')
#ggplot(data = dataSMA.EMA, aes(x = index(dataSMA.EMA))) + 
#  geom_line(aes(y= Retornos, color='Retornos')) +
#  geom_line(aes(y= SMA, color='SMA')) +
#  geom_line(aes(y= EMA, color='EMA')) +
#  labs(x = "Fecha",y = "", color = "") + theme_minimal()
#chart.TimeSeries(dataSMA.EMA, lwd = 1, legend.loc = "topright", colorset = #c('grey',"darkgreen","firebrick"))
#lines(SMA(Cl(na.omit(jp)), n = 200), col = "darkgreen")
#lines(EMA(Cl(na.omit(jp)), n = 200), col = "firebrick")

# media incondicional
plot(na.omit(jp), main= "Media movil y exponencial USD/JPY")
lines(SMA(Cl(na.omit(jp)), n = 200), col = "darkgreen")
lines(EMA(Cl(na.omit(jp)), n = 200), col = "firebrick")
#Observar si hay un proceso de autocorrelación, si la media es cero, la varianza constante, etc.
```
```{r echo=FALSE,fig.pos='h',fig.height = 3, fig.width = 7, fig.align = "center"}
lines(EMA(Cl(na.omit(jp)), n = 200), col = "green")
```


```{r echo= FALSE, fig.height = 3, fig.width = 7, fig.align = "center", warning = FALSE,fig.pos='h',fig.show= 'hide'}
# medias moviles retornos
plot(jp_r, main= "Media movil y exponencial de retornos USD/JPY")
lines(SMA(jp_r, n = 100), col = "red")
#Observar si hay un proceso de autocorrelación, si la media es cero, la varianza constante, etc.
```
```{r echo=FALSE,fig.pos='h',fig.height = 3, fig.width = 7, fig.align = "center"}
lines(EMA(jp_r, n = 100), col = "green")
```

  c. Modelación de la varianza condicional (verifique la existencia de efecto leverage o asimetrías comparando diferentes especificaciones usando criterios de información). ¿Cuál es el modelo que mejor se ajusta al proceso de volatilidad de la tasa de cambio?
  
```{r echo=FALSE, fig.align="center", fig.height=5, fig.pos='h', fig.width=5, message=FALSE, warning=FALSE}
grid.arrange(
ggAcf(jp_r,52)+ggtitle("Retornos diarios")+labs(x=""),
ggPacf(jp_r,52)+ggtitle("")
)
#No necesidad de modelar la media del proceso.
```

```{r echo=FALSE, fig.height = 5, fig.width = 5, fig.align = "center", warning = FALSE,fig.pos='h',message=FALSE}
grid.arrange(
ggAcf(jp_r^2,52)+ggtitle("Volatilidad retornos diarios")+labs(x=""),
ggPacf(jp_r^2,52)+ggtitle("")
)
#Necesidad de modelar la varianza.
```

```{r echo=FALSE ,message=FALSE}
garch11.spec = ugarchspec(variance.model = list(garchOrder=c(1,1)),
                          mean.model = list(armaOrder=c(0,0)))
garch11.fit = ugarchfit(spec=garch11.spec, data=jp_r)
garch11.fit

```

Se observa alpha y beta significativos, dan cuenta  de clustering y persistencia.
mu no es significativo, su media es cero.
omega es la constante de la volatilidad, ie, media de largo plazo de la volatilidad del proceso. No significativa.
alpha+beta es casi 1; es un modelo estacionario.
alpha es sesnibilidad a la llegada de información y beta es persistencia de la volatilidad.
Nyblom: hay cambio estructural en mu, alpha y beta. No en omega.
Leverage: no hay conjunto, hay sesgo solamente negativo.
Comparar por bondad de ajuste y criterios de información.

  d. Pronóstico de la volatilidad a 10 días.
  
  e. Cuál es la probabilidad de tener pérdidas con el 99% de confianza en un horizonte de día (use los resultados de su modelación para el cálculo).
  
```{r echo= FALSE,message=FALSE}
# asuminedo distribucion normal
mu_R<- mean(jp_r)
sigma_R<- sd(jp_r)
W0<- 100000
W0*qnorm(0.01, mean= mu_R, sd<- sigma_R)
```
  
  f. ¿Cambió la pandemia del COVID-19 la estructura de la volatilidad de la tasa de cambio? (para eso use datos desde enero del 2018).
  

Nota: Se espera que cada grupo ELIJA UNA TASA DE CAMBIO DIFERENTE, y presente un informe ejecutivo de no más de 10 páginas, en el que de respuesta a cada pregunta y presente los argumentos empíricos necesarios que la sustenten. Explique sus resultados e interprételos.

